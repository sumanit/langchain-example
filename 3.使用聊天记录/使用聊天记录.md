# 聊天记录
在构建机器人应用时,我们希望机器人的回答能结合聊天记录进行回复,而不是仅仅针对本次的输入进行回复,所以需要引入聊天记录功能
langchain支持了多种类型的聊天记录存储能力

使用聊天记录需要以下组件
- MessagesPlaceholder 用于将聊天记录插入到调用大模型时的消息列表中
- BaseChatMessageHistory 用于保存和读取聊天记录
- RunnableConfig  用于设置当前的用户 session_id
- RunnableWithMessageHistory 用于将chain和聊天记录及消息组合起来

## 调用示例
```python
from langchain_community.chat_message_histories import FileChatMessageHistory, SQLChatMessageHistory
from langchain_core.runnables import RunnableWithMessageHistory
from langchain_ollama import OllamaLLM
from common.ollama_helper import get_optimal_deepseek
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

model_name = get_optimal_deepseek()
print(model_name)
# 初始化模型
ollama_llm = OllamaLLM(model=model_name,
                       base_url="http://127.0.0.1:11434")
# 定义子消息模板
prompt = ChatPromptTemplate.from_messages(
    [
        ("system", "你是健康智能助手."),
        MessagesPlaceholder(variable_name="history"),
        ("human", "{question}"),
    ]
)
chain = prompt | ollama_llm;
config = {"configurable": {"session_id": "suman35"}}
# 历史记录处理器
def get_message_history(session_id: str) -> FileChatMessageHistory:
    print(session_id)
    return FileChatMessageHistory(file_path=f"./history/{session_id}.json")
chain_with_history = RunnableWithMessageHistory(
    chain,
    get_message_history,
    input_messages_key="question",
    history_messages_key="history",
)
response = chain_with_history.invoke({"question": "昨天天气怎么样"}, config=config)
```
## 类继承关系

```
 BaseChatMessageHistory
    +-- AstraDBChatMessageHistory
    +-- CassandraChatMessageHistory
    +-- CosmosDBChatMessageHistory
    +-- DynamoDBChatMessageHistory
    +-- ElasticsearchChatMessageHistory
    +-- FileChatMessageHistory             文件存储
    +-- FirestoreChatMessageHistory
    +-- InMemoryChatMessageHistory         内存存储
    +-- KafkaChatMessageHistory            
    +-- MomentoChatMessageHistory
    +-- MongoDBChatMessageHistory
    +-- Neo4jChatMessageHistory
    +-- PostgresChatMessageHistory
    +-- RedisChatMessageHistory
    +-- RocksetChatMessageHistory
    +-- SQLChatMessageHistory
    +-- SingleStoreDBChatMessageHistory
    +-- StreamlitChatMessageHistory
    +-- TiDBChatMessageHistory
    +-- UpstashRedisChatMessageHistory
    +-- XataChatMessageHistory
    +-- ZepChatMessageHistory
    +-- ZepCloudChatMessageHistory
```